<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeEasy - プログラミング穴埋めクイズ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; -webkit-tap-highlight-color: transparent; }
        pre, code { font-family: 'Roboto Mono', monospace; }
        .quiz-card, .course-card { background: #fff; border-radius: 20px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:active { transform: scale(0.96); }
        .correct-answer { background-color: #2dd4bf !important; color: white !important; border-color: #2dd4bf !important; }
        .wrong-answer { background-color: #fb7185 !important; color: white !important; border-color: #fb7185 !important; }
        .disabled-option { opacity: 0.6; pointer-events: none; }
        #loader-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.3s ease-in-out; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #0d9488; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* 画面切り替えアニメーション */
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Pyodide ローディング画面 -->
    <div id="loader-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-slate-600 font-semibold">実行環境を準備中...</p>
    </div>

    <div class="w-full max-w-md mx-auto p-4">
        <!-- ホーム画面 (コース選択) -->
        <div id="home-screen" class="screen active">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold text-slate-800">CodeEasy</h1>
                <p class="text-slate-500">挑戦するコースを選んでください</p>
            </header>
            <div id="course-list" class="space-y-4">
                <!-- コースリストはJSで生成 -->
            </div>
            <div class="mt-6 space-y-3">
                 <button id="create-quiz-btn" class="btn w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-teal-600">新しい問題を作成</button>
                 <button onclick="document.getElementById('import-file-input').click()" class="btn w-full bg-slate-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-slate-700">問題をインポート</button>
                 <input type="file" id="import-file-input" class="hidden" accept=".json">
            </div>
        </div>

        <!-- クイズ画面 -->
        <div id="quiz-screen" class="screen">
            <header class="text-center mb-4">
                <h1 id="quiz-title" class="text-2xl font-bold text-slate-800"></h1>
            </header>
            <div class="w-full bg-slate-200 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-teal-400 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <main id="quiz-container">
                <div class="quiz-card p-6">
                    <p id="question-number" class="text-sm font-bold text-slate-500 mb-2"></p>
                    <div class="bg-slate-800 text-white rounded-lg p-4 text-left">
                        <pre><code id="code-snippet" class="whitespace-pre-wrap"></code></pre>
                    </div>
                    <div class="mt-4">
                        <p class="text-xs text-slate-500 font-bold mb-1">実行結果の例</p>
                        <div class="bg-slate-200 text-slate-700 rounded-lg p-3 text-left text-sm">
                            <pre><code id="expected-output"></code></pre>
                        </div>
                    </div>
                </div>
                <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6"></div>
                <div id="feedback-container" class="mt-6 text-center h-auto min-h-[80px] flex items-center justify-center flex-col"></div>
                <div id="output-container" class="hidden mt-2 text-left w-full">
                    <p class="text-xs text-slate-500 font-bold mb-1">あなたの回答での実行結果</p>
                    <div class="bg-slate-800 text-white rounded-lg p-3">
                        <pre><code id="actual-output" class="whitespace-pre-wrap text-sm"></code></pre>
                    </div>
                </div>
                <div class="mt-4 space-y-3">
                     <button id="next-button" class="hidden w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-slate-800 btn">次の問題へ</button>
                     <button id="back-to-home-btn-quiz" class="btn w-full bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-400">コース選択に戻る</button>
                </div>
            </main>
        </div>
        
        <!-- クイズ完了画面 -->
        <div id="result-screen" class="screen">
            <div class="text-center p-8 bg-white rounded-2xl shadow-xl">
                 <h2 class="text-2xl font-bold text-slate-800 mb-2">コースクリア！</h2>
                 <p class="text-slate-600 mb-6">お疲れ様でした！結果はこちらです。</p>
                 <div class="text-5xl mb-6">🎉</div>
                 <div class="space-y-3 text-left bg-slate-100 p-4 rounded-lg mb-6">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-slate-600">正解数:</span>
                        <span id="result-score" class="font-bold text-lg text-slate-800"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-slate-600">正答率:</span>
                        <span id="result-accuracy" class="font-bold text-lg text-slate-800"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-slate-600">回答時間:</span>
                        <span id="result-time" class="font-bold text-lg text-slate-800"></span>
                    </div>
                 </div>
                 <button id="restart-button" class="btn w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-teal-600">もう一度挑戦する</button>
                 <button id="back-to-home-btn-result" class="btn w-full bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg mt-3">コース選択に戻る</button>
            </div>
        </div>

        <!-- 問題作成・編集画面 -->
        <div id="editor-screen" class="screen">
             <header class="text-center mb-6 flex justify-between items-center">
                <div class="w-12"></div> <!-- Spacer -->
                <h1 class="text-2xl font-bold text-slate-800">問題を作成・編集</h1>
                <button id="show-tips-btn" class="text-teal-500 font-bold text-sm w-12">ヒント</button>
            </header>
            <div class="space-y-4 bg-white p-6 rounded-2xl shadow-lg">
                <div>
                    <label class="font-bold text-slate-600">コース名</label>
                    <input type="text" id="course-title-input" placeholder="例: Python中級編" class="w-full p-2 border border-slate-300 rounded-md mt-1">
                </div>
                <div id="question-editor-list">
                    <!-- 質問エディタがここに追加される -->
                </div>
                <button id="add-question-btn" class="btn w-full bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">+ 問題を追加</button>
            </div>
             <div class="mt-6 space-y-3">
                 <button id="save-quiz-btn" class="btn w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-teal-600">保存してプレイ</button>
                 <button id="export-quiz-btn" class="btn w-full bg-sky-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-sky-600">エクスポート</button>
                 <button id="back-to-home-btn-editor" class="btn w-full bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-400 mt-2">ホームに戻る</button>
            </div>
        </div>
    </div>
    
    <!-- Tips Modal -->
    <div id="tips-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 relative">
            <button id="close-tips-btn" class="absolute top-3 right-4 text-slate-500 hover:text-slate-700 text-2xl font-bold">&times;</button>
            <div id="tips-content">
                <!-- Tips content will be dynamically inserted here -->
            </div>
            <div class="flex justify-between items-center mt-6">
                <button id="prev-tip-btn" class="btn bg-slate-200 text-slate-700 px-4 py-2 rounded-lg">&lt; 前へ</button>
                <p id="tip-pagination" class="text-sm text-slate-500 font-semibold"></p>
                <button id="next-tip-btn" class="btn bg-slate-200 text-slate-700 px-4 py-2 rounded-lg">次へ &gt;</button>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const screens = document.querySelectorAll('.screen');
        const loaderOverlay = document.getElementById('loader-overlay');
        const courseList = document.getElementById('course-list');
        const quizTitleEl = document.getElementById('quiz-title');
        const progressBar = document.getElementById('progress-bar');
        const questionNumberEl = document.getElementById('question-number');
        const codeSnippetEl = document.getElementById('code-snippet');
        const expectedOutputEl = document.getElementById('expected-output');
        const optionsContainer = document.getElementById('options-container');
        const feedbackContainer = document.getElementById('feedback-container');
        const outputContainer = document.getElementById('output-container');
        const actualOutputEl = document.getElementById('actual-output');
        const nextButton = document.getElementById('next-button');
        const restartButton = document.getElementById('restart-button');
        const resultScoreEl = document.getElementById('result-score');
        const resultAccuracyEl = document.getElementById('result-accuracy');
        const resultTimeEl = document.getElementById('result-time');
        const createQuizBtn = document.getElementById('create-quiz-btn');
        const importFileInput = document.getElementById('import-file-input');
        const questionEditorList = document.getElementById('question-editor-list');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const saveQuizBtn = document.getElementById('save-quiz-btn');
        const exportQuizBtn = document.getElementById('export-quiz-btn');
        const courseTitleInput = document.getElementById('course-title-input');
        const tipsModal = document.getElementById('tips-modal');
        const showTipsBtn = document.getElementById('show-tips-btn');
        const closeTipsBtn = document.getElementById('close-tips-btn');
        const tipsContentEl = document.getElementById('tips-content');
        const prevTipBtn = document.getElementById('prev-tip-btn');
        const nextTipBtn = document.getElementById('next-tip-btn');
        const tipPaginationEl = document.getElementById('tip-pagination');

        // App State
        let pyodide;
        let quizSets = {};
        let currentQuizData = null;
        let currentQuestionIndex = 0;
        let isAnswered = false;
        let correctAnswersCount = 0;
        let quizStartTime = 0;
        let currentTipIndex = 0;

        const defaultQuizData = {
            "python-basics": {
                title: "Python基礎編",
                language: "python",
                questions: [
                    { question: "name = \"Taro\"\nprint(f\"Hello, {@__@}\")", options: ["name", "\"name\"", "{name}", "f-name"], answer: "name", explanation: "f文字列では、変数を波括弧 {} で囲むことでその値を文字列に埋め込めます。", expectedOutput: "Hello, Taro" },
                    { question: "fruits = [\"apple\", \"banana\", \"cherry\"]\nprint(fruits[@__@])", options: ["0", "1", "2", "3"], answer: "1", explanation: "リストのインデックスは0から始まります。2番目の要素にアクセスするにはインデックス1を指定します。", expectedOutput: "banana" },
                    { question: "for i in range(3):\n    print(@__@)", options: ["i", "\"i\"", "range", "3"], answer: "i", explanation: "forループは指定された範囲の各要素を変数 'i' に順番に代入しながら繰り返します。", expectedOutput: "0\n1\n2" },
                    { question: "def say_hello():\n    print(\"Hello!\")\n\n@__@", options: ["say_hello", "say_hello()", "def say_hello", "print(say_hello)"], answer: "say_hello()", explanation: "関数を呼び出して実行するには、関数名の後ろに括弧 () をつけます。", expectedOutput: "Hello!" },
                    { question: "age = 20\nif age >= 18:\n    print(\"Adult\")\n@__@:\n    print(\"Minor\")", options: ["if", "elif", "else", "then"], answer: "else", explanation: "if文の条件が偽の場合に実行されるブロックを指定するには、elseキーワードを使用します。", expectedOutput: "Adult" }
                ]
            }
        };

        const tips = [
            {
                title: "基本的な問題の作り方",
                content: `
                    <p class="text-slate-600 mb-4">各項目を入力して、オリジナルの問題を作成しましょう。</p>
                    <ul class="space-y-3 text-sm text-left">
                        <li><strong class="font-bold text-slate-700">問題コード:</strong> 穴埋めにしたい部分を <code class="bg-slate-200 px-1 rounded">@__@</code> と記述します。</li>
                        <li><strong class="font-bold text-slate-700">選択肢:</strong> 4つの選択肢をすべて入力します。</li>
                        <li><strong class="font-bold text-slate-700">正解:</strong> ドロップダウンから正解の選択肢を選びます。</li>
                        <li><strong class="font-bold text-slate-700">解説:</strong> なぜその答えになるのか、学習の助けになる説明を書きましょう。</li>
                        <li><strong class="font-bold text-slate-700">実行結果の例:</strong> 正解のコードを実行したときの正しい出力結果を入力します。</li>
                    </ul>
                `
            },
            {
                title: "良い問題を作るコツ",
                content: `
                    <p class="text-slate-600 mb-4">学習者が楽しく学べるような、質の高い問題を作るためのヒントです。</p>
                    <ul class="space-y-3 text-sm text-left">
                        <li><strong class="font-bold text-slate-700">💡 核心を突く問題:</strong> 言語の重要な概念や、初心者がつまずきやすいポイントを問題にしましょう。</li>
                        <li><strong class="font-bold text-slate-700">🤔 紛らわしい選択肢:</strong> 間違いの選択肢は、なぜそれが間違いなのか考えさせるような、意味のあるものにしましょう。</li>
                        <li><strong class="font-bold text-slate-700">✨ 丁寧な解説:</strong> 正解の理由だけでなく、なぜ他の選択肢が違うのかも説明すると、より深い理解につながります。</li>
                    </ul>
                `
            }
        ];

        // --- Navigation ---
        function navigateTo(screenId) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // --- Pyodide & Initialization ---
        async function initializePyodide() {
            pyodide = await loadPyodide();
            loaderOverlay.style.opacity = '0';
            setTimeout(() => loaderOverlay.style.display = 'none', 300);
            loadQuizzes();
            renderCourseList();
            navigateTo('home-screen');
        }
        
        // --- Quiz Management (Load, Save, Render) ---
        function loadQuizzes() {
            const storedQuizzes = localStorage.getItem('codeEasyQuizzes');
            quizSets = storedQuizzes ? JSON.parse(storedQuizzes) : defaultQuizData;
        }

        function saveQuizzes() {
            localStorage.setItem('codeEasyQuizzes', JSON.stringify(quizSets));
        }

        function getLanguageIcon(language) {
            if (language === 'python') {
                return `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><path d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18z"></path><path d="M10.5 8.5a.5.5 0 0 0-1 0v7a.5.5 0 0 0 1 0v-7z"></path><path d="M14.5 12.5a.5.5 0 0 0-1 0v3a.5.5 0 0 0 1 0v-3z"></path><path d="M10 8.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"></path><path d="M14 15.5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5z"></path></svg>`;
            }
            return '';
        }

        function renderCourseList() {
            courseList.innerHTML = '';
            Object.keys(quizSets).forEach(id => {
                const course = quizSets[id];
                const courseCard = document.createElement('div');
                courseCard.className = 'course-card p-4 flex justify-between items-center';
                courseCard.innerHTML = `
                    <div class="flex items-center space-x-3">
                        ${getLanguageIcon(course.language)}
                        <div>
                            <h2 class="font-bold text-lg text-slate-800">${course.title}</h2>
                            <p class="text-sm text-slate-500">${course.questions.length} 問</p>
                        </div>
                    </div>
                    <button class="btn bg-teal-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-teal-600">プレイ</button>
                `;
                courseCard.querySelector('button').onclick = () => startQuiz(id);
                courseList.appendChild(courseCard);
            });
        }
        
        // --- Quiz Gameplay ---
        function startQuiz(quizId) {
            currentQuizData = quizSets[quizId];
            currentQuestionIndex = 0;
            correctAnswersCount = 0;
            quizStartTime = Date.now();
            quizTitleEl.textContent = currentQuizData.title;
            displayQuestion();
            navigateTo('quiz-screen');
        }

        function displayQuestion() {
            isAnswered = false;
            outputContainer.classList.add('hidden');
            feedbackContainer.innerHTML = '';
            nextButton.classList.add('hidden');

            const progress = ((currentQuestionIndex) / currentQuizData.questions.length) * 100;
            progressBar.style.width = `${progress}%`;
            
            const q = currentQuizData.questions[currentQuestionIndex];
            questionNumberEl.textContent = `問 ${currentQuestionIndex + 1} / ${currentQuizData.questions.length}`;
            codeSnippetEl.innerHTML = q.question.replace(/@__@/g, '<span class="bg-slate-600 px-2 py-1 rounded-md">@__@</span>');
            expectedOutputEl.textContent = q.expectedOutput;

            optionsContainer.innerHTML = '';
            const shuffledOptions = [...q.options].sort(() => Math.random() - 0.5);
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = `<code>${option}</code>`;
                button.className = 'btn w-full bg-white p-4 rounded-lg text-slate-700 font-semibold border-2 border-slate-200 hover:bg-slate-50 hover:border-teal-400';
                button.onclick = () => checkAnswer(option, button);
                optionsContainer.appendChild(button);
            });
        }

        async function checkAnswer(selectedOption, selectedButton) {
            if (isAnswered) return;
            isAnswered = true;

            const q = currentQuizData.questions[currentQuestionIndex];
            const isCorrect = selectedOption === q.answer;
            if (isCorrect) correctAnswersCount++;
            
            selectedButton.classList.add(isCorrect ? 'correct-answer' : 'wrong-answer');
            feedbackContainer.innerHTML = `
                <div class="flex items-center ${isCorrect ? 'text-teal-500' : 'text-rose-500'} justify-center">
                    <p class="text-xl font-bold">${isCorrect ? '正解！' : '不正解'}</p>
                </div>
                <p class="text-sm text-slate-600 mt-1 px-4">${q.explanation}</p>
            `;

            const codeToRun = q.question.replace('@__@', selectedOption);
            const actualOutput = await runPythonCode(codeToRun);
            actualOutputEl.textContent = actualOutput || '(出力なし)';
            outputContainer.classList.remove('hidden');

            Array.from(optionsContainer.children).forEach(button => {
                button.classList.add('disabled-option');
                if (button.textContent === q.answer) {
                    button.classList.add('correct-answer');
                }
            });

            nextButton.classList.remove('hidden');
            nextButton.textContent = (currentQuestionIndex >= currentQuizData.questions.length - 1) ? '結果を見る' : '次の問題へ';
        }
        
        async function runPythonCode(code) {
            try {
                const wrappedCode = `import sys, io; from contextlib import redirect_stdout; f = io.StringIO();
with redirect_stdout(f):
    try: exec(${JSON.stringify(code)})
    except Exception as e: print(e)
f.getvalue()`;
                return (await pyodide.runPythonAsync(wrappedCode)).trim();
            } catch (err) { return err.toString(); }
        }

        function showNextQuestion() {
            currentQuestionIndex++;
            (currentQuestionIndex < currentQuizData.questions.length) ? displayQuestion() : displayResults();
        }

        function displayResults() {
            const totalQuestions = currentQuizData.questions.length;
            const accuracy = Math.round((correctAnswersCount / totalQuestions) * 100);
            const elapsedTime = Math.round((Date.now() - quizStartTime) / 1000);

            resultScoreEl.textContent = `${correctAnswersCount} / ${totalQuestions} 問`;
            resultAccuracyEl.textContent = `${accuracy}%`;
            resultTimeEl.textContent = `${elapsedTime}秒`;
            
            navigateTo('result-screen');
        }

        // --- Quiz Editor ---
        function openQuizEditor() {
            courseTitleInput.value = '';
            questionEditorList.innerHTML = '';
            addQuestionEditor();
            navigateTo('editor-screen');
        }

        function addQuestionEditor(q = { question: '', options: ['', '', '', ''], answer: '', explanation: '', expectedOutput: '' }) {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-editor-item border-t border-slate-200 mt-4 pt-4';
            const questionIndex = questionEditorList.children.length;
            questionDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <p class="font-bold text-slate-700">問題 ${questionIndex + 1}</p>
                    <button class="text-red-500 text-sm font-semibold">この問題を削除</button>
                </div>
                <textarea class="w-full p-2 border rounded mt-1" rows="3" placeholder="コードを入力 (例: print(@__@))">${q.question}</textarea>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    ${q.options.map((opt, i) => `<input type="text" value="${opt}" class="w-full p-2 border rounded" placeholder="選択肢 ${i + 1}">`).join('')}
                </div>
                <select class="w-full p-2 border rounded mt-2">
                    ${q.options.map((opt, i) => `<option value="${opt}" ${opt === q.answer ? 'selected' : ''}>正解: 選択肢 ${i + 1}</option>`).join('')}
                </select>
                <input type="text" value="${q.explanation}" class="w-full p-2 border rounded mt-2" placeholder="解説">
                <input type="text" value="${q.expectedOutput}" class="w-full p-2 border rounded mt-2" placeholder="実行結果の例">
            `;
            questionEditorList.appendChild(questionDiv);
            
            const optionInputs = questionDiv.querySelectorAll('input[placeholder^="選択肢"]');
            const answerSelect = questionDiv.querySelector('select');
            optionInputs.forEach((input, index) => {
                input.oninput = () => {
                    answerSelect.options[index].value = input.value;
                    answerSelect.options[index].text = `正解: 選択肢 ${index + 1} (${input.value})`;
                };
            });
            questionDiv.querySelector('button').onclick = () => {
                questionDiv.remove();
                // Re-number questions
                questionEditorList.querySelectorAll('.question-editor-item p:first-child').forEach((p, i) => {
                    p.textContent = `問題 ${i + 1}`;
                });
            };
        }
        
        function saveQuizFromEditor() {
            const title = courseTitleInput.value.trim();
            if (!title) { alert('コース名を入力してください。'); return; }
            const questions = [];
            const questionEditors = questionEditorList.querySelectorAll('.question-editor-item');
            for (const editor of questionEditors) {
                const question = editor.querySelector('textarea').value;
                const options = Array.from(editor.querySelectorAll('input[placeholder^="選択肢"]')).map(el => el.value);
                const answer = editor.querySelector('select').value;
                const explanation = editor.querySelector('input[placeholder="解説"]').value;
                const expectedOutput = editor.querySelector('input[placeholder="実行結果の例"]').value;
                if(question && options.every(o => o) && answer) {
                    questions.push({ question, options, answer, explanation, expectedOutput });
                }
            }
            if (questions.length === 0) { alert('有効な問題がありません。'); return; }
            
            const quizId = `custom-${Date.now()}`;
            quizSets[quizId] = { title, questions, language: 'python' }; // Currently only supports Python
            saveQuizzes();
            startQuiz(quizId);
        }

        // --- Import / Export ---
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const quizData = JSON.parse(e.target.result);
                    if (!quizData.title || !Array.isArray(quizData.questions) || quizData.questions.length === 0) {
                        throw new Error('無効なJSON形式、または問題が含まれていません。');
                    }
                    
                    const quizId = `imported-${Date.now()}`;
                    quizSets[quizId] = { language: 'python', ...quizData };
                    saveQuizzes();
                    renderCourseList();
                    alert(`「${quizData.title}」が正常にインポートされました。`);
                } catch (err) {
                    alert(`ファイルの読み込みに失敗しました。\n${err.message}`);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function handleExport() {
            const title = courseTitleInput.value.trim();
            if (!title) { alert('コース名を入力してください。'); return; }
            const questions = Array.from(questionEditorList.querySelectorAll('.question-editor-item')).map(editor => ({
                question: editor.querySelector('textarea').value,
                options: Array.from(editor.querySelectorAll('input[placeholder^="選択肢"]')).map(el => el.value),
                answer: editor.querySelector('select').value,
                explanation: editor.querySelector('input[placeholder="解説"]').value,
                expectedOutput: editor.querySelector('input[placeholder="実行結果の例"]').value
            }));

            const dataStr = JSON.stringify({ title, questions, language: 'python' }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/\s/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // --- Tips Modal Logic ---
        function showTip(index) {
            const tip = tips[index];
            tipsContentEl.innerHTML = `
                <h3 class="text-xl font-bold text-slate-800 text-center mb-1">${tip.title}</h3>
                ${tip.content}
            `;
            tipPaginationEl.textContent = `${index + 1} / ${tips.length}`;
            prevTipBtn.disabled = index === 0;
            prevTipBtn.classList.toggle('opacity-50', index === 0);
            nextTipBtn.disabled = index === tips.length - 1;
            nextTipBtn.classList.toggle('opacity-50', index === tips.length - 1);
        }

        // Event Listeners
        document.querySelectorAll('[id^="back-to-home-btn"]').forEach(btn => btn.onclick = () => {
            renderCourseList();
            navigateTo('home-screen');
        });
        nextButton.onclick = showNextQuestion;
        restartButton.onclick = () => startQuiz(Object.keys(quizSets).find(key => quizSets[key].title === currentQuizData.title));
        createQuizBtn.onclick = openQuizEditor;
        importFileInput.onchange = handleImport;
        addQuestionBtn.onclick = () => addQuestionEditor();
        saveQuizBtn.onclick = saveQuizFromEditor;
        exportQuizBtn.onclick = handleExport;
        
        showTipsBtn.onclick = () => {
            tipsModal.classList.remove('hidden');
            tipsModal.querySelector('div').classList.add('animate-fadeIn');
            currentTipIndex = 0;
            showTip(currentTipIndex);
        };
        closeTipsBtn.onclick = () => tipsModal.classList.add('hidden');
        prevTipBtn.onclick = () => {
            if (currentTipIndex > 0) {
                currentTipIndex--;
                showTip(currentTipIndex);
            }
        };
        nextTipBtn.onclick = () => {
            if (currentTipIndex < tips.length - 1) {
                currentTipIndex++;
                showTip(currentTipIndex);
            }
        };

        // Start App
        initializePyodide();
    </script>
</body>
</html>