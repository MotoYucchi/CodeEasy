<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeEasy - ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ç©´åŸ‹ã‚ã‚¯ã‚¤ã‚º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; -webkit-tap-highlight-color: transparent; }
        pre, code { font-family: 'Roboto Mono', monospace; }
        .quiz-card, .course-card { background: #fff; border-radius: 20px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:active { transform: scale(0.96); }
        .correct-answer { background-color: #2dd4bf !important; color: white !important; border-color: #2dd4bf !important; }
        .wrong-answer { background-color: #fb7185 !important; color: white !important; border-color: #fb7185 !important; }
        .disabled-option { opacity: 0.6; pointer-events: none; }
        #loader-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.3s ease-in-out; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #0d9488; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100">

    <audio id="bgm-player" src="bgm.mp3" loop></audio>

    <div id="loader-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-slate-600 font-semibold">å®Ÿè¡Œç’°å¢ƒã‚’æº–å‚™ä¸­...</p>
    </div>

    <div class="w-full max-w-md mx-auto p-4">
        <div id="home-screen" class="screen active">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold text-slate-800">CodeEasy</h1>
                <p class="text-slate-500">æŒ‘æˆ¦ã™ã‚‹ã‚³ãƒ¼ã‚¹ã‚’é¸ã‚“ã§ãã ã•ã„</p>
            </header>
            <div id="course-list" class="space-y-4">
                </div>
            <div class="mt-6 space-y-3">
                 <button id="create-quiz-btn" class="btn w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-teal-600">æ–°ã—ã„å•é¡Œã‚’ä½œæˆ</button>
                 <button onclick="document.getElementById('import-file-input').click()" class="btn w-full bg-slate-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-slate-700">å•é¡Œã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                 <input type="file" id="import-file-input" class="hidden" accept=".json">
            </div>
        </div>

        <div id="quiz-screen" class="screen">
            <header class="text-center mb-4">
                <h1 id="quiz-title" class="text-2xl font-bold text-slate-800"></h1>
            </header>
            <div class="w-full bg-slate-200 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-teal-400 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <main id="quiz-container">
                <div class="quiz-card p-6">
                    <p id="question-number" class="text-sm font-bold text-slate-500 mb-2"></p>
                    <div class="bg-slate-800 text-white rounded-lg p-4 text-left">
                        <pre><code id="code-snippet" class="whitespace-pre-wrap"></code></pre>
                    </div>
                    <div class="mt-4">
                        <p class="text-xs text-slate-500 font-bold mb-1">å®Ÿè¡Œçµæœã®ä¾‹</p>
                        <div class="bg-slate-200 text-slate-700 rounded-lg p-3 text-left text-sm">
                            <pre><code id="expected-output"></code></pre>
                        </div>
                    </div>
                </div>
                <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6"></div>
                <div id="feedback-container" class="mt-6 text-center h-auto min-h-[80px] flex items-center justify-center flex-col"></div>
                <div id="output-container" class="hidden mt-2 text-left w-full">
                    <p class="text-xs text-slate-500 font-bold mb-1">ã‚ãªãŸã®å›ç­”ã§ã®å®Ÿè¡Œçµæœ</p>
                    <div class="bg-slate-800 text-white rounded-lg p-3">
                        <pre><code id="actual-output" class="whitespace-pre-wrap text-sm"></code></pre>
                    </div>
                </div>
                <div class="mt-4 space-y-3">
                     <button id="next-button" class="hidden w-full bg-slate-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-slate-800 btn">æ¬¡ã®å•é¡Œã¸</button>
                     <button id="back-to-home-btn-quiz" class="btn w-full bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-400">ã‚³ãƒ¼ã‚¹é¸æŠã«æˆ»ã‚‹</button>
                </div>
            </main>
        </div>
        
        <div id="result-screen" class="screen">
            <div class="text-center p-8 bg-white rounded-2xl shadow-xl">
                 <h2 class="text-2xl font-bold text-slate-800 mb-2">ã‚³ãƒ¼ã‚¹ã‚¯ãƒªã‚¢ï¼</h2>
                 <p class="text-slate-600 mb-6">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼çµæœã¯ã“ã¡ã‚‰ã§ã™ã€‚</p>
                 <div class="text-5xl mb-6">ğŸ‰</div>
                 <div class="space-y-3 text-left bg-slate-100 p-4 rounded-lg mb-6">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-slate-600">æ­£è§£æ•°:</span>
                        <span id="result-score" class="font-bold text-lg text-slate-800"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-slate-600">æ­£ç­”ç‡:</span>
                        <span id="result-accuracy" class="font-bold text-lg text-slate-800"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-slate-600">å›ç­”æ™‚é–“:</span>
                        <span id="result-time" class="font-bold text-lg text-slate-800"></span>
                    </div>
                 </div>
                 <button id="restart-button" class="btn w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-teal-600">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹</button>
                 <button id="back-to-home-btn-result" class="btn w-full bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg mt-3">ã‚³ãƒ¼ã‚¹é¸æŠã«æˆ»ã‚‹</button>
            </div>
        </div>

        <div id="editor-screen" class="screen">
             <header class="text-center mb-6 flex justify-between items-center">
                <div class="w-12"></div> <h1 class="text-2xl font-bold text-slate-800">å•é¡Œã‚’ä½œæˆãƒ»ç·¨é›†</h1>
                <button id="show-tips-btn" class="text-teal-500 font-bold text-sm w-12">ãƒ’ãƒ³ãƒˆ</button>
            </header>
            <div class="space-y-4 bg-white p-6 rounded-2xl shadow-lg">
                <div>
                    <label class="font-bold text-slate-600">ã‚³ãƒ¼ã‚¹å</label>
                    <input type="text" id="course-title-input" placeholder="ä¾‹: Pythonä¸­ç´šç·¨" class="w-full p-2 border border-slate-300 rounded-md mt-1">
                </div>
                <div id="question-editor-list">
                    </div>
                <button id="add-question-btn" class="btn w-full bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">+ å•é¡Œã‚’è¿½åŠ </button>
            </div>
             <div class="mt-6 space-y-3">
                 <button id="save-quiz-btn" class="btn w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-teal-600">ä¿å­˜ã—ã¦ãƒ—ãƒ¬ã‚¤</button>
                 <button id="export-quiz-btn" class="btn w-full bg-sky-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-sky-600">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                 <button id="back-to-home-btn-editor" class="btn w-full bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-400 mt-2">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
            </div>
        </div>
    </div>
    
    <div id="tips-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 relative">
            <button id="close-tips-btn" class="absolute top-3 right-4 text-slate-500 hover:text-slate-700 text-2xl font-bold">&times;</button>
            <div id="tips-content">
                </div>
            <div class="flex justify-between items-center mt-6">
                <button id="prev-tip-btn" class="btn bg-slate-200 text-slate-700 px-4 py-2 rounded-lg">&lt; å‰ã¸</button>
                <p id="tip-pagination" class="text-sm text-slate-500 font-semibold"></p>
                <button id="next-tip-btn" class="btn bg-slate-200 text-slate-700 px-4 py-2 rounded-lg">æ¬¡ã¸ &gt;</button>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const screens = document.querySelectorAll('.screen');
        const loaderOverlay = document.getElementById('loader-overlay');
        const courseList = document.getElementById('course-list');
        const quizTitleEl = document.getElementById('quiz-title');
        const progressBar = document.getElementById('progress-bar');
        const questionNumberEl = document.getElementById('question-number');
        const codeSnippetEl = document.getElementById('code-snippet');
        const expectedOutputEl = document.getElementById('expected-output');
        const optionsContainer = document.getElementById('options-container');
        const feedbackContainer = document.getElementById('feedback-container');
        const outputContainer = document.getElementById('output-container');
        const actualOutputEl = document.getElementById('actual-output');
        const nextButton = document.getElementById('next-button');
        const restartButton = document.getElementById('restart-button');
        const resultScoreEl = document.getElementById('result-score');
        const resultAccuracyEl = document.getElementById('result-accuracy');
        const resultTimeEl = document.getElementById('result-time');
        const createQuizBtn = document.getElementById('create-quiz-btn');
        const importFileInput = document.getElementById('import-file-input');
        const questionEditorList = document.getElementById('question-editor-list');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const saveQuizBtn = document.getElementById('save-quiz-btn');
        const exportQuizBtn = document.getElementById('export-quiz-btn');
        const courseTitleInput = document.getElementById('course-title-input');
        const tipsModal = document.getElementById('tips-modal');
        const showTipsBtn = document.getElementById('show-tips-btn');
        const closeTipsBtn = document.getElementById('close-tips-btn');
        const tipsContentEl = document.getElementById('tips-content');
        const prevTipBtn = document.getElementById('prev-tip-btn');
        const nextTipBtn = document.getElementById('next-tip-btn');
        const tipPaginationEl = document.getElementById('tip-pagination');

        // App State
        let pyodide;
        let quizSets = {};
        let currentQuizData = null;
        let currentQuestionIndex = 0;
        let isAnswered = false;
        let correctAnswersCount = 0;
        let quizStartTime = 0;
        let currentTipIndex = 0;

        const defaultQuizData = {
            "python-basics": {
                title: "PythonåŸºç¤ç·¨",
                language: "python",
                questions: [
                    { question: "name = \"Taro\"\nprint(f\"Hello, {@__@}\")", options: ["name", "\"name\"", "{name}", "f-name"], answer: "name", explanation: "fæ–‡å­—åˆ—ã§ã¯ã€å¤‰æ•°ã‚’æ³¢æ‹¬å¼§ {} ã§å›²ã‚€ã“ã¨ã§ãã®å€¤ã‚’æ–‡å­—åˆ—ã«åŸ‹ã‚è¾¼ã‚ã¾ã™ã€‚", expectedOutput: "Hello, Taro" },
                    { question: "fruits = [\"apple\", \"banana\", \"cherry\"]\nprint(fruits[@__@])", options: ["0", "1", "2", "3"], answer: "1", explanation: "ãƒªã‚¹ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯0ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚2ç•ªç›®ã®è¦ç´ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1ã‚’æŒ‡å®šã—ã¾ã™ã€‚", expectedOutput: "banana" },
                    { question: "for i in range(3):\n    print(@__@)", options: ["i", "\"i\"", "range", "3"], answer: "i", explanation: "forãƒ«ãƒ¼ãƒ—ã¯æŒ‡å®šã•ã‚ŒãŸç¯„å›²ã®å„è¦ç´ ã‚’å¤‰æ•° 'i' ã«é †ç•ªã«ä»£å…¥ã—ãªãŒã‚‰ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚", expectedOutput: "0\n1\n2" },
                    { question: "def say_hello():\n    print(\"Hello!\")\n\n@__@", options: ["say_hello", "say_hello()", "def say_hello", "print(say_hello)"], answer: "say_hello()", explanation: "é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦å®Ÿè¡Œã™ã‚‹ã«ã¯ã€é–¢æ•°åã®å¾Œã‚ã«æ‹¬å¼§ () ã‚’ã¤ã‘ã¾ã™ã€‚", expectedOutput: "Hello!" },
                    { question: "age = 20\nif age >= 18:\n    print(\"Adult\")\n@__@:\n    print(\"Minor\")", options: ["if", "elif", "else", "then"], answer: "else", explanation: "ifæ–‡ã®æ¡ä»¶ãŒå½ã®å ´åˆã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŒ‡å®šã™ã‚‹ã«ã¯ã€elseã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚", expectedOutput: "Adult" }
                ]
            }
        };

        const tips = [
            {
                title: "åŸºæœ¬çš„ãªå•é¡Œã®ä½œã‚Šæ–¹",
                content: `
                    <p class="text-slate-600 mb-4">å„é …ç›®ã‚’å…¥åŠ›ã—ã¦ã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã®å•é¡Œã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚</p>
                    <ul class="space-y-3 text-sm text-left">
                        <li><strong class="font-bold text-slate-700">å•é¡Œã‚³ãƒ¼ãƒ‰:</strong> ç©´åŸ‹ã‚ã«ã—ãŸã„éƒ¨åˆ†ã‚’ <code class="bg-slate-200 px-1 rounded">@__@</code> ã¨è¨˜è¿°ã—ã¾ã™ã€‚</li>
                        <li><strong class="font-bold text-slate-700">é¸æŠè‚¢:</strong> 4ã¤ã®é¸æŠè‚¢ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¾ã™ã€‚</li>
                        <li><strong class="font-bold text-slate-700">æ­£è§£:</strong> ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰æ­£è§£ã®é¸æŠè‚¢ã‚’é¸ã³ã¾ã™ã€‚</li>
                        <li><strong class="font-bold text-slate-700">è§£èª¬:</strong> ãªãœãã®ç­”ãˆã«ãªã‚‹ã®ã‹ã€å­¦ç¿’ã®åŠ©ã‘ã«ãªã‚‹èª¬æ˜ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚</li>
                        <li><strong class="font-bold text-slate-700">å®Ÿè¡Œçµæœã®ä¾‹:</strong> æ­£è§£ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã¨ãã®æ­£ã—ã„å‡ºåŠ›çµæœã‚’å…¥åŠ›ã—ã¾ã™ã€‚</li>
                    </ul>
                `
            },
            {
                title: "è‰¯ã„å•é¡Œã‚’ä½œã‚‹ã‚³ãƒ„",
                content: `
                    <p class="text-slate-600 mb-4">å­¦ç¿’è€…ãŒæ¥½ã—ãå­¦ã¹ã‚‹ã‚ˆã†ãªã€è³ªã®é«˜ã„å•é¡Œã‚’ä½œã‚‹ãŸã‚ã®ãƒ’ãƒ³ãƒˆã§ã™ã€‚</p>
                    <ul class="space-y-3 text-sm text-left">
                        <li><strong class="font-bold text-slate-700">ğŸ’¡ æ ¸å¿ƒã‚’çªãå•é¡Œ:</strong> è¨€èªã®é‡è¦ãªæ¦‚å¿µã‚„ã€åˆå¿ƒè€…ãŒã¤ã¾ãšãã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆã‚’å•é¡Œã«ã—ã¾ã—ã‚‡ã†ã€‚</li>
                        <li><strong class="font-bold text-slate-700">ğŸ¤” ç´›ã‚‰ã‚ã—ã„é¸æŠè‚¢:</strong> é–“é•ã„ã®é¸æŠè‚¢ã¯ã€ãªãœãã‚ŒãŒé–“é•ã„ãªã®ã‹è€ƒãˆã•ã›ã‚‹ã‚ˆã†ãªã€æ„å‘³ã®ã‚ã‚‹ã‚‚ã®ã«ã—ã¾ã—ã‚‡ã†ã€‚</li>
                        <li><strong class="font-bold text-slate-700">âœ¨ ä¸å¯§ãªè§£èª¬:</strong> æ­£è§£ã®ç†ç”±ã ã‘ã§ãªãã€ãªãœä»–ã®é¸æŠè‚¢ãŒé•ã†ã®ã‹ã‚‚èª¬æ˜ã™ã‚‹ã¨ã€ã‚ˆã‚Šæ·±ã„ç†è§£ã«ã¤ãªãŒã‚Šã¾ã™ã€‚</li>
                    </ul>
                `
            }
        ];

        // --- Navigation ---
        function navigateTo(screenId) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        // --- BGMå†ç”Ÿæ©Ÿèƒ½ (æ–°è¦è¿½åŠ ) ---
        function playBGM() {
            const bgmPlayer = document.getElementById('bgm-player');
            if (bgmPlayer) {
                // ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼ã«å¯¾å¿œ
                const playPromise = bgmPlayer.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.warn("BGMã®è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œå¾Œã«å†ç”Ÿã‚’è©¦ã¿ã¾ã™ã€‚", error);
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç”»é¢ã‚’åˆã‚ã¦ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«å†ç”Ÿã‚’è©¦ã¿ã‚‹
                        document.body.addEventListener('click', () => {
                            if (bgmPlayer.paused) {
                                bgmPlayer.play();
                            }
                        }, { once: true });
                    });
                }
            }
        }

        // --- Pyodide & Initialization (ä¿®æ­£) ---
        async function initializePyodide() {
            pyodide = await loadPyodide();
            loaderOverlay.style.opacity = '0';
            setTimeout(() => loaderOverlay.style.display = 'none', 300);
            
            // BGMå†ç”Ÿå‡¦ç†ã‚’å‘¼ã³å‡ºã—
            playBGM();

            await loadQuizzes(); // éåŒæœŸã«å¤‰æ›´ã—ãŸãŸã‚ await ã‚’è¿½åŠ 
            renderCourseList();
            navigateTo('home-screen');
        }
        
        // --- Quiz Management (Load, Save, Render) ---

        // loadQuizzes ã‚’ async ã«å¤‰æ›´ (ä¿®æ­£)
        async function loadQuizzes() {
            const storedQuizzes = localStorage.getItem('codeEasyQuizzes');
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¯ã‚¤ã‚ºã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ quizSets ã‚’åˆæœŸåŒ–
            quizSets = { ...defaultQuizData };
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚¯ã‚¤ã‚ºã‚’è¿½åŠ 
            if(storedQuizzes) {
                 const userQuizzes = JSON.parse(storedQuizzes);
                 Object.assign(quizSets, userQuizzes);
            }

            // --- è¿½åŠ æ©Ÿèƒ½ï¼šå¤–éƒ¨JSONã®èª­ã¿è¾¼ã¿ ---
            try {
                // 1. questions/index.json ã‚’èª­ã¿è¾¼ã‚€
                const indexResponse = await fetch('questions/index.json');
                if (!indexResponse.ok) {
                    // index.json ãŒãªã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¯ã‚¤ã‚ºã®ã¿ä½¿ç”¨ã™ã‚‹
                    console.log("questions/index.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å¤–éƒ¨ã‚¯ã‚¤ã‚ºã¯èª­ã¿è¾¼ã¿ã¾ã›ã‚“ã€‚");
                    return; 
                }
                
                const quizFileList = await indexResponse.json();
                
                if (Array.isArray(quizFileList)) {
                    // 2. index.json ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å„ã‚¯ã‚¤ã‚ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
                    const fetchPromises = quizFileList.map(async (fileName) => {
                        try {
                            const quizResponse = await fetch(`questions/${fileName}`);
                            if (!quizResponse.ok) {
                                console.error(`ã‚¯ã‚¤ã‚ºãƒ•ã‚¡ã‚¤ãƒ« ${fileName} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
                                return null;
                            }
                            const quizData = await quizResponse.json();
                            
                            // ç°¡æ˜“çš„ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                            if (quizData.title && Array.isArray(quizData.questions)) {
                                const quizId = `external-${fileName.replace('.json', '')}`;
                                return { id: quizId, data: { language: 'python', ...quizData } };
                            } else {
                                console.warn(`ãƒ•ã‚¡ã‚¤ãƒ« ${fileName} ã¯ç„¡åŠ¹ãªå½¢å¼ã§ã™ã€‚`);
                                return null;
                            }
                        } catch (err) {
                            console.error(`ã‚¯ã‚¤ã‚ºãƒ•ã‚¡ã‚¤ãƒ« ${fileName} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, err);
                            return null;
                        }
                    });
                    
                    const loadedQuizzes = await Promise.all(fetchPromises);
                    
                    // æˆåŠŸã—ãŸã‚¯ã‚¤ã‚ºã®ã¿ quizSets ã«è¿½åŠ 
                    loadedQuizzes.forEach(quiz => {
                        if (quiz) {
                            quizSets[quiz.id] = quiz.data;
                        }
                    });
                }
            } catch (err) {
                console.error("å¤–éƒ¨ã‚¯ã‚¤ã‚ºã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", err);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚¯ã‚¤ã‚ºã§ç¶šè¡Œã™ã‚‹
            }
            // --- è¿½åŠ æ©Ÿèƒ½ã“ã“ã¾ã§ ---
        }

        // saveQuizzes ã‚’ä¿®æ­£ (å¤–éƒ¨ã‚¯ã‚¤ã‚ºã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¯ã‚¤ã‚ºã‚’ä¿å­˜å¯¾è±¡å¤–ã«)
        function saveQuizzes() {
            // ç¾åœ¨ã® quizSets ã‹ã‚‰ã€ä¿å­˜å¯¾è±¡ã®ã‚¯ã‚¤ã‚ºï¼ˆcustom- ã¾ãŸã¯ imported-ï¼‰ã®ã¿ã‚’æŠ½å‡º
            const quizzesToSave = {};
            Object.keys(quizSets).forEach(key => {
                if (key.startsWith('custom-') || key.startsWith('imported-')) {
                    quizzesToSave[key] = quizSets[key];
                }
            });
            
            localStorage.setItem('codeEasyQuizzes', JSON.stringify(quizzesToSave));
        }

        function getLanguageIcon(language) {
            if (language === 'python') {
                return `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><path d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18z"></path><path d="M10.5 8.5a.5.5 0 0 0-1 0v7a.5.5 0 0 0 1 0v-7z"></path><path d="M14.5 12.5a.5.5 0 0 0-1 0v3a.5.5 0 0 0 1 0v-3z"></path><path d="M10 8.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"></path><path d="M14 15.5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5z"></path></svg>`;
            }
            return '';
        }

        function renderCourseList() {
            courseList.innerHTML = '';
            // èª­ã¿è¾¼ã‚“ã ã™ã¹ã¦ã®ã‚¯ã‚¤ã‚ºã‚»ãƒƒãƒˆã‚’è¡¨ç¤º
            Object.keys(quizSets).forEach(id => {
                const course = quizSets[id];
                const courseCard = document.createElement('div');
                courseCard.className = 'course-card p-4 flex justify-between items-center';
                courseCard.innerHTML = `
                    <div class="flex items-center space-x-3">
                        ${getLanguageIcon(course.language)}
                        <div>
                            <h2 class="font-bold text-lg text-slate-800">${course.title}</h2>
                            <p class="text-sm text-slate-500">${course.questions.length} å•</p>
                        </div>
                    </div>
                    <button class="btn bg-teal-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-teal-600">ãƒ—ãƒ¬ã‚¤</button>
                `;
                courseCard.querySelector('button').onclick = () => startQuiz(id);
                courseList.appendChild(courseCard);
            });
        }
        
        // --- Quiz Gameplay ---
        function startQuiz(quizId) {
            currentQuizData = quizSets[quizId];
            if (!currentQuizData) {
                alert('ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                navigateTo('home-screen');
                return;
            }
            currentQuestionIndex = 0;
            correctAnswersCount = 0;
            quizStartTime = Date.now();
            quizTitleEl.textContent = currentQuizData.title;
            displayQuestion();
            navigateTo('quiz-screen');
        }

        function displayQuestion() {
            isAnswered = false;
            outputContainer.classList.add('hidden');
            feedbackContainer.innerHTML = '';
            nextButton.classList.add('hidden');

            const progress = ((currentQuestionIndex) / currentQuizData.questions.length) * 100;
            progressBar.style.width = `${progress}%`;
            
            const q = currentQuizData.questions[currentQuestionIndex];
            questionNumberEl.textContent = `å• ${currentQuestionIndex + 1} / ${currentQuizData.questions.length}`;
            codeSnippetEl.innerHTML = q.question.replace(/@__@/g, '<span class="bg-slate-600 px-2 py-1 rounded-md">@__@</span>');
            expectedOutputEl.textContent = q.expectedOutput;

            optionsContainer.innerHTML = '';
            const shuffledOptions = [...q.options].sort(() => Math.random() - 0.5);
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = `<code>${option}</code>`;
                button.className = 'btn w-full bg-white p-4 rounded-lg text-slate-700 font-semibold border-2 border-slate-200 hover:bg-slate-50 hover:border-teal-400';
                button.onclick = () => checkAnswer(option, button);
                optionsContainer.appendChild(button);
            });
        }

        async function checkAnswer(selectedOption, selectedButton) {
            if (isAnswered) return;
            isAnswered = true;

            const q = currentQuizData.questions[currentQuestionIndex];
            const isCorrect = selectedOption === q.answer;
            if (isCorrect) correctAnswersCount++;
            
            selectedButton.classList.add(isCorrect ? 'correct-answer' : 'wrong-answer');
            feedbackContainer.innerHTML = `
                <div class="flex items-center ${isCorrect ? 'text-teal-500' : 'text-rose-500'} justify-center">
                    <p class="text-xl font-bold">${isCorrect ? 'æ­£è§£ï¼' : 'ä¸æ­£è§£'}</p>
                </div>
                <p class="text-sm text-slate-600 mt-1 px-4">${q.explanation}</p>
            `;

            const codeToRun = q.question.replace('@__@', selectedOption);
            const actualOutput = await runPythonCode(codeToRun);
            actualOutputEl.textContent = actualOutput || '(å‡ºåŠ›ãªã—)';
            outputContainer.classList.remove('hidden');

            Array.from(optionsContainer.children).forEach(button => {
                button.classList.add('disabled-option');
                if (button.textContent === q.answer) {
                    button.classList.add('correct-answer');
                }
            });

            nextButton.classList.remove('hidden');
            nextButton.textContent = (currentQuestionIndex >= currentQuizData.questions.length - 1) ? 'çµæœã‚’è¦‹ã‚‹' : 'æ¬¡ã®å•é¡Œã¸';
        }
        
        async function runPythonCode(code) {
            try {
                const wrappedCode = `import sys, io; from contextlib import redirect_stdout; f = io.StringIO();
with redirect_stdout(f):
    try: exec(${JSON.stringify(code)})
    except Exception as e: print(e)
f.getvalue()`;
                return (await pyodide.runPythonAsync(wrappedCode)).trim();
            } catch (err) { return err.toString(); }
        }

        function showNextQuestion() {
            currentQuestionIndex++;
            (currentQuestionIndex < currentQuizData.questions.length) ? displayQuestion() : displayResults();
        }

        function displayResults() {
            const totalQuestions = currentQuizData.questions.length;
            const accuracy = Math.round((correctAnswersCount / totalQuestions) * 100);
            const elapsedTime = Math.round((Date.now() - quizStartTime) / 1000);

            resultScoreEl.textContent = `${correctAnswersCount} / ${totalQuestions} å•`;
            resultAccuracyEl.textContent = `${accuracy}%`;
            resultTimeEl.textContent = `${elapsedTime}ç§’`;
            
            navigateTo('result-screen');
        }

        // --- Quiz Editor ---
        function openQuizEditor() {
            courseTitleInput.value = '';
            questionEditorList.innerHTML = '';
            addQuestionEditor();
            navigateTo('editor-screen');
        }

        function addQuestionEditor(q = { question: '', options: ['', '', '', ''], answer: '', explanation: '', expectedOutput: '' }) {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-editor-item border-t border-slate-200 mt-4 pt-4';
            const questionIndex = questionEditorList.children.length;
            questionDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <p class="font-bold text-slate-700">å•é¡Œ ${questionIndex + 1}</p>
                    <button class="text-red-500 text-sm font-semibold">ã“ã®å•é¡Œã‚’å‰Šé™¤</button>
                </div>
                <textarea class="w-full p-2 border rounded mt-1" rows="3" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ› (ä¾‹: print(@__@))">${q.question}</textarea>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    ${q.options.map((opt, i) => `<input type="text" value="${opt.replace(/"/g, '&quot;')}" class="w-full p-2 border rounded" placeholder="é¸æŠè‚¢ ${i + 1}">`).join('')}
                </div>
                <select class="w-full p-2 border rounded mt-2">
                    ${q.options.map((opt, i) => `<option value="${opt.replace(/"/g, '&quot;')}" ${opt === q.answer ? 'selected' : ''}>æ­£è§£: é¸æŠè‚¢ ${i + 1}</option>`).join('')}
                </select>
                <input type="text" value="${q.explanation.replace(/"/g, '&quot;')}" class="w-full p-2 border rounded mt-2" placeholder="è§£èª¬">
                <input type="text" value="${q.expectedOutput.replace(/"/g, '&quot;')}" class="w-full p-2 border rounded mt-2" placeholder="å®Ÿè¡Œçµæœã®ä¾‹">
            `;
            questionEditorList.appendChild(questionDiv);
            
            const optionInputs = questionDiv.querySelectorAll('input[placeholder^="é¸æŠè‚¢"]');
            const answerSelect = questionDiv.querySelector('select');
            optionInputs.forEach((input, index) => {
                input.oninput = () => {
                    answerSelect.options[index].value = input.value;
                    answerSelect.options[index].text = `æ­£è§£: é¸æŠè‚¢ ${index + 1} (${input.value})`;
                };
            });
            questionDiv.querySelector('button').onclick = () => {
                questionDiv.remove();
                // Re-number questions
                questionEditorList.querySelectorAll('.question-editor-item p:first-child').forEach((p, i) => {
                    p.textContent = `å•é¡Œ ${i + 1}`;
                });
            };
        }
        
        function saveQuizFromEditor() {
            const title = courseTitleInput.value.trim();
            if (!title) { alert('ã‚³ãƒ¼ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
            const questions = [];
            const questionEditors = questionEditorList.querySelectorAll('.question-editor-item');
            for (const editor of questionEditors) {
                const question = editor.querySelector('textarea').value;
                const options = Array.from(editor.querySelectorAll('input[placeholder^="é¸æŠè‚¢"]')).map(el => el.value);
                const answer = editor.querySelector('select').value;
                const explanation = editor.querySelector('input[placeholder="è§£èª¬"]').value;
                const expectedOutput = editor.querySelector('input[placeholder="å®Ÿè¡Œçµæœã®ä¾‹"]').value;
                if(question && options.every(o => o) && answer) {
                    questions.push({ question, options, answer, explanation, expectedOutput });
                }
            }
            if (questions.length === 0) { alert('æœ‰åŠ¹ãªå•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }
            
            const quizId = `custom-${Date.now()}`;
            quizSets[quizId] = { title, questions, language: 'python' }; // Currently only supports Python
            saveQuizzes(); // ã“ã“ã§ä¿å­˜
            startQuiz(quizId);
        }

        // --- Import / Export ---
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const quizData = JSON.parse(e.target.result);
                    if (!quizData.title || !Array.isArray(quizData.questions) || quizData.questions.length === 0) {
                        throw new Error('ç„¡åŠ¹ãªJSONå½¢å¼ã€ã¾ãŸã¯å•é¡ŒãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                    }
                    
                    const quizId = `imported-${Date.now()}`;
                    quizSets[quizId] = { language: 'python', ...quizData };
                    saveQuizzes(); // ã“ã“ã§ä¿å­˜
                    renderCourseList();
                    alert(`ã€Œ${quizData.title}ã€ãŒæ­£å¸¸ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸã€‚`);
                } catch (err) {
                    alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${err.message}`);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function handleExport() {
            const title = courseTitleInput.value.trim();
            if (!title) { alert('ã‚³ãƒ¼ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
            const questions = Array.from(questionEditorList.querySelectorAll('.question-editor-item')).map(editor => ({
                question: editor.querySelector('textarea').value,
                options: Array.from(editor.querySelectorAll('input[placeholder^="é¸æŠè‚¢"]')).map(el => el.value),
                answer: editor.querySelector('select').value,
                explanation: editor.querySelector('input[placeholder="è§£èª¬"]').value,
                expectedOutput: editor.querySelector('input[placeholder="å®Ÿè¡Œçµæœã®ä¾‹"]').value
            }));

            const dataStr = JSON.stringify({ title, questions, language: 'python' }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/\s/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // --- Tips Modal Logic ---
        function showTip(index) {
            const tip = tips[index];
            tipsContentEl.innerHTML = `
                <h3 class="text-xl font-bold text-slate-800 text-center mb-1">${tip.title}</h3>
                ${tip.content}
            `;
            tipPaginationEl.textContent = `${index + 1} / ${tips.length}`;
            prevTipBtn.disabled = index === 0;
            prevTipBtn.classList.toggle('opacity-50', index === 0);
            nextTipBtn.disabled = index === tips.length - 1;
            nextTipBtn.classList.toggle('opacity-50', index === tips.length - 1);
        }

        // Event Listeners
        document.querySelectorAll('[id^="back-to-home-btn"]').forEach(btn => btn.onclick = () => {
            renderCourseList();
            navigateTo('home-screen');
        });
        nextButton.onclick = showNextQuestion;
        restartButton.onclick = () => {
            const currentQuizId = Object.keys(quizSets).find(key => quizSets[key].title === currentQuizData.title);
            if(currentQuizId) {
                startQuiz(currentQuizId);
            }
        };
        createQuizBtn.onclick = openQuizEditor;
        importFileInput.onchange = handleImport;
        addQuestionBtn.onclick = () => addQuestionEditor();
        saveQuizBtn.onclick = saveQuizFromEditor;
        exportQuizBtn.onclick = handleExport;
        
        showTipsBtn.onclick = () => {
            tipsModal.classList.remove('hidden');
            tipsModal.querySelector('div').classList.add('animate-fadeIn');
            currentTipIndex = 0;
            showTip(currentTipIndex);
        };
        closeTipsBtn.onclick = () => tipsModal.classList.add('hidden');
        prevTipBtn.onclick = () => {
            if (currentTipIndex > 0) {
                currentTipIndex--;
                showTip(currentTipIndex);
            }
        };
        nextTipBtn.onclick = () => {
            if (currentTipIndex < tips.length - 1) {
                currentTipIndex++;
                showTip(currentTipIndex);
            }
        };

        // Start App
        initializePyodide();
    </script>
</body>
</html>